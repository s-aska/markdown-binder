<html>
<head>
<title>The Document of Aska</title>
<link rel="stylesheet" type="text/css" href="/static/css/style.css" media="all" />
<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Crimson+Text">
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.0/jquery.min.js"></script>
<script>
var pushed = false;
function load_file(file) {
    if (history.pushState) {
        history.pushState(file, "", location.protocol + "//" + location.host + file);
    }
    do_load_file(file);
    return false;
}
function autoHeight() {
    $("#content").removeAttr('style');
    $("#sidebar").removeAttr('style');
    var sidebar_height = $("#sidebar").height();
    var content_height = $("#content").height();
    if (sidebar_height > content_height) {
        $("#content").height(sidebar_height);
    } else {
        $("#sidebar").height(content_height);
    }
}
function permalink(file) {
	var url = location.protocol + "//" + location.host + file;
	var navi = $(document.createElement('span'));
	navi.attr('class', 'permalink');
	var plink = $(document.createElement('a'));
	plink.text('permalink');
	plink.attr('href', file);
	var source = $(document.createElement('a'));
	source.text('source');
	if (file.length > 1) {
		source.attr('href', file + '.txt');
	} else {
		source.attr('href', 'TOP.txt');
	}
	source.attr('target', '_blank');
	navi.append(plink);
	navi.append(document.createTextNode(' | '));
	navi.append(source);
	$("#content").append(navi);
}
function initContent(file) {
	autoHeight();
	permalink(file);
    $("#content").find("a").each(function(){
    	if ($(this).attr("href").match(/^https?:/)) {
    		$(this).attr("target", "_blank");
    	} else {
    		$(this).bind("click", function(){return load_file(file)});
    	}
    });
}
function do_load_file(file) {
	var url = file;
    if (url == "/") {
    	url = url + "TOP";
    }
    if (jQuery.browser.msie) {
    	url = encodeURI(url);
    }
    $.ajax({
        url: url + ".html",
        success: function(html){
            $("#content").html(html);
            pushed = true;
            initContent(file);
        }
    });
}
$(document).ready(function() {
    if (history.pushState) {
        history.pushState("/", "", location.protocol + "//" + location.host + location.pathname);
        window.addEventListener("popstate", function (event) {
            if (pushed) {
                do_load_file(event.state);
            }
        });
    }
    $("#sidebar dt").hover(function(){
        $(this).css("cursor","pointer"); 
    },function(){
        $(this).css("cursor","default"); 
    });
    $("#sidebar dt").click(function(){
        var ele = $(this).next();
        if (ele.length > 0 && ele.get(0).tagName.toLowerCase() == "dl") {
            ele.slideToggle("fast");
        }
    });
    initContent(location.pathname);
    /*
    $("#sidebar dd").each(function(){
        $(this).next().hide();
    });
    */
});
</script>
<!--[if IE]>
<script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
<![endif]-->
</head>
<body>
<h1 id="siteTitle">The Document of Aska</h1>
<div id="wrapper" class="clearfix">
<nav id="sidebar">
[% SET dep = 0 %]
[% SET cur_dep = 0 %]
[% FOREACH file IN files %]
[% SET cur_dep = file.depth %]
[% IF dep < cur_dep %]
[% '<dl>'.repeat(cur_dep - dep) | mark_raw %][% SET dep = cur_dep %]
[% ELSIF dep > cur_dep %]
[% '</dl>'.repeat(dep - cur_dep) | mark_raw %][% SET dep = cur_dep %]
[% END %]
[% IF file.is_dir %]
<dt>[% file.basename %]</dt>
[% ELSE %]
[% SET path = file == '/TOP.txt' ? '/' : file.stringify.replace('.txt$', '') %]
<dd><a onClick="return load_file($(this).data().file)" data-file="[% path %]" href="[% path %]">[% file.basename.replace('.txt$', '') %]</a></dd>
[% END %]
[% END %]
[% '</dl>'.repeat(dep) | mark_raw %]
</nav>
<article>
<div id="content">[% content | mark_raw %]</div>
</article>
</div>
<footer>© 2011 <a href="http://www.7kai.org/">七階</a></footer>
</body>
</html>
